name: Scheduled tests

on:
  # Runs when manually triggered from the GitHub UI.
  workflow_dispatch:

  # Runs on a daily schedule at 06:00 UTC.
  schedule:
    - cron: '0 6 * * *'

concurrency:
  group: scheduled-tests
  cancel-in-progress: false

env:
  NODE_VERSION: 22
  PYTHON_VERSION: 3.14

jobs:
  end_to_end_tests:
    name: End-to-end tests
    strategy:
      fail-fast: false
      # Reduced to 1 to prevent exceeding Apify free tier memory limits (8GB total)
      max-parallel: 1
      matrix:
        # Reduced to 2 tests to keep total runtime under 90 minutes
        # Tests both browser (playwright) and non-browser (beautifulsoup) crawlers
        crawler-type: ["playwright", "beautifulsoup"]
        # Only test with httpx (most common/stable HTTP client)
        http-client: ["httpx"]
        # Only test with uv (fastest package manager)
        package-manager: ["uv"]

    runs-on: "ubuntu-latest"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm install -g apify-cli

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # installed to be able to patch crawlee in the poetry.lock with custom wheel file for poetry based templates
      - name: Install poetry
        run: pipx install poetry

      - name: Set up uv package manager
        uses: astral-sh/setup-uv@v7
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # Sync the project, but no need to install the browsers into the test runner environment.
      - name: Install Python dependencies
        run: make install-sync

      - name: Run templates end-to-end tests
        run: make e2e-templates-tests args="-m ${{ matrix.http-client }} and ${{ matrix.crawler-type }} and ${{ matrix.package-manager }}"
        env:
          APIFY_TEST_USER_API_TOKEN: ${{ secrets.APIFY_TEST_USER_API_TOKEN }}
